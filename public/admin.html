<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>High Blend - Panel de Control</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { 
            --rojo: #e63946; 
            --negro: #0b0b0b; 
            --gris-oscuro: #1a1a1a; 
            --verde: #2a9d8f; 
            --azul: #457b9d; 
            --naranja: #f4a261; 
            --blanco-sucio: #e0e0e0;
        }

        body { 
            font-family: 'Inter', 'Segoe UI', sans-serif; 
            background: var(--negro); 
            color: var(--blanco-sucio); 
            margin: 0; 
            padding: 0; 
        }

        /* --- NOTIFICACIONES --- */
        #toast { 
            position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 6px; 
            color: white; background-color: var(--verde); font-weight: bold; z-index: 5000; 
            display: none; box-shadow: 0 8px 16px rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.1);
        }

        /* --- ANIMACI√ìN ALERTA --- */
        @keyframes parpadeo-alerta {
            0% { border: 4px solid var(--rojo); box-shadow: 0 0 15px var(--rojo); }
            50% { border: 4px solid #ffcc00; box-shadow: 0 0 35px #ffcc00; }
            100% { border: 4px solid var(--rojo); box-shadow: 0 0 15px var(--rojo); }
        }
        .card-nueva { animation: parpadeo-alerta 0.6s infinite !important; transform: scale(1.02); z-index: 100; }

        /* --- LOGIN --- */
        #login-screen { display: flex; height: 100vh; justify-content: center; align-items: center; background: #050505; }
        .login-box { background: #fff; padding: 40px; border-radius: 12px; text-align: center; width: 320px; color: #1a1a1a; box-shadow: 0 10px 40px rgba(230, 57, 70, 0.2); }
        .login-box h2 { margin-bottom: 25px; letter-spacing: -1px; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .btn-login { width: 100%; padding: 12px; background: var(--rojo); color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 8px; font-size: 1rem; transition: 0.2s; }
        .btn-login:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(230, 57, 70, 0.4); }

        /* --- PANEL PRINCIPAL --- */
        #admin-panel { display: none; padding: 25px; max-width: 1400px; margin: auto; }
        
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 3px solid var(--rojo); padding-bottom: 20px; margin-bottom: 30px; 
        }
        
        .stats { background: var(--gris-oscuro); padding: 15px 25px; border-radius: 12px; display: flex; gap: 30px; border: 1px solid #333; }
        .stat-item span { display: block; font-size: 0.7rem; color: #888; text-transform: uppercase; font-weight: 800; }
        .stat-item strong { font-size: 1.5rem; color: var(--rojo); }

        /* --- TABS --- */
        .nav-tabs { margin-bottom: 25px; display: flex; gap: 12px; }
        .nav-tabs button { 
            padding: 14px 24px; cursor: pointer; background: var(--gris-oscuro); color: #aaa; 
            border: 1px solid #333; border-radius: 8px; font-weight: bold; transition: 0.3s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .nav-tabs button.active { background: var(--rojo); color: white; border-color: var(--rojo); }

        /* --- GRID Y CARDS --- */
        .grid-pedidos { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        
        .card { 
            background: #fff; color: #1a1a1a; border-radius: 12px; overflow: hidden; 
            display: flex; flex-direction: column; height: 520px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 4px solid transparent; transition: 0.3s;
        }
        .card-header { background: #f4f4f4; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: 900; border-bottom: 1px solid #ddd; }
        .card-body { padding: 20px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .card-footer { padding: 12px; background: #f9f9f9; display: flex; gap: 8px; border-top: 1px solid #eee; }

        .item-line { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; font-weight: 600; }
        .cliente-info { margin-top: auto; background: #f1f1f1; padding: 15px; border-radius: 10px; border-left: 6px solid var(--rojo); font-size: 0.9rem; }
        .cliente-info strong { color: #000; font-size: 1.1rem; }
        .cliente-info h3 { margin: 8px 0 0 0; color: var(--rojo); font-size: 1.6rem; text-align: right; }

        /* --- BOTONES --- */
        .btn { border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: 800; flex: 1; text-transform: uppercase; font-size: 0.8rem; transition: 0.2s; }
        .btn-ready { background: var(--verde); color: white; }
        .btn-cancel { background: #ddd; color: #666; }
        .btn:active { transform: scale(0.95); }
        
        /* --- BADGES --- */
        .badge { padding: 5px 10px; border-radius: 6px; font-size: 0.7rem; color: white; font-weight: 900; }
        .badge-pendiente { background: var(--naranja); }
        .badge-esperando { background: #ffd166; color: #000; } 
        .badge-cancelado { background: #8d99ae; }
        .badge-enviado { background: var(--verde); }

        /* --- MENU Y TABLAS --- */
        .menu-container { background: #fff; color: #333; padding: 30px; border-radius: 15px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--verde); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* --- MODALES --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 4000; backdrop-filter: blur(5px); }
        .modal-content { background: #fff; color: #333; width: 90%; max-width: 400px; margin: 80px auto; padding: 30px; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.8); }
        
        input[type="text"], input[type="number"], select { 
            width: 100%; padding: 12px; margin: 8px 0 15px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; 
        }

        th { padding: 12px; border-bottom: 2px solid #eee; text-align: left; color: #888; font-size: 0.8rem; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div id="toast"></div>

<div id="modal-anular" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3 style="margin-top:0; color: var(--rojo); font-size: 1.8rem;">‚ö†Ô∏è ¬øAnular?</h3>
        <p>¬øEst√°s seguro de cancelar este pedido?</p>
        <input type="hidden" id="anular-id">
        <button onclick="confirmarAnulacion()" class="btn btn-ready" style="background:var(--rojo); width:100%; margin-bottom: 10px;">S√ç, ANULAR</button>
        <button class="btn btn-cancel" style="width:100%;" onclick="cerrarModalAnular()">CANCELAR</button>
    </div>
</div>

<div id="modal-editar" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color: var(--azul);">Editar Producto</h3>
        <input type="hidden" id="edit-id">
        <label>Nombre:</label><input type="text" id="edit-nombre">
        <label>Precio:</label><input type="number" id="edit-precio">
        <label>Categor√≠a:</label><select id="edit-categoria-select"></select>
        <label>Descripci√≥n:</label><input type="text" id="edit-desc">
        <button onclick="actualizarProducto()" class="btn btn-ready" style="width:100%; margin-bottom:10px;">GUARDAR</button>
        <button class="btn btn-cancel" style="width:100%;" onclick="cerrarModal()">CANCELAR</button>
    </div>
</div>

<div id="login-screen">
    <div class="login-box">
        <h1 style="color: var(--rojo); margin: 0; font-size: 2.2rem;">HIGH BLEND</h1>
        <p style="margin-bottom: 20px; font-weight: bold; color: #888;">ADMIN PANEL</p>
        <input type="text" id="user" placeholder="Usuario">
        <input type="password" id="pass" placeholder="Contrase√±a">
        <button class="btn-login" onclick="intentarLogin()">ENTRAR</button>
        <p id="error-msg" style="color: red; display: none; font-weight: bold; margin-top: 15px;">Error de acceso</p>
    </div>
</div>

<div id="admin-panel">
    <header>
        <div style="background: var(--gris-oscuro); padding: 12px 20px; border-radius: 10px; display: flex; align-items: center; gap: 15px; border: 1px solid #333;">
            <span style="font-weight: 800; font-size: 0.8rem;">LOCAL:</span>
            <label class="switch">
                <input type="checkbox" id="switch-local" onchange="toggleLocal(this.checked)">
                <span class="slider"></span>
            </label>
            <strong id="texto-local" style="font-size: 0.9rem;">CERRADO</strong>
        </div>
        
        <div style="text-align: center;">
            <h2 style="margin:0; letter-spacing: -1px; font-size: 1.8rem;">CONTROL DE PEDIDOS / MENU</h2>
            <input type="date" id="filtro-fecha" onchange="cargarPedidos()" style="padding: 8px; margin-top:10px; background: #333; color: #fff; border: none; border-radius: 5px;">
        </div>

        <div class="stats">
            <div class="stat-item"><span>Ventas</span><strong id="stat-ventas">$0</strong></div>
            <div class="stat-item"><span>Pedidos</span><strong id="stat-cantidad">0</strong></div>
            <button onclick="logout()" style="background:transparent; border:1px solid #555; color:#888; padding:8px 15px; border-radius:6px; cursor:pointer; font-weight: bold;">Salir</button>
        </div>
    </header>

    <div class="nav-tabs">
        <button id="btn-tab-pedidos" class="active" onclick="switchTab('pedidos')">Pendientes</button>
        <button id="btn-tab-despachados" onclick="switchTab('despachados')">Despachados</button>
        <button id="btn-tab-menu" onclick="switchTab('menu')">Men√∫ / Stock</button>
        <button id="btn-tab-consultas" onclick="switchTab('consultas')">Reportes</button>
    </div>

    <div id="tab-pedidos"><div class="grid-pedidos" id="contenedor-pedidos"></div></div>
    
    <div id="tab-despachados" style="display:none;">
        <input type="date" id="filtro-fecha-despachados" onchange="cargarPedidos()" style="margin-bottom:20px; padding:10px; background: var(--gris-oscuro); color: #fff; border: 1px solid #333; border-radius: 8px;">
        <div class="grid-pedidos" id="contenedor-despachados"></div>
    </div>

    <div id="tab-menu" style="display:none;">
        <div class="menu-container">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px; margin-bottom:30px;">
                <div style="background:#f9f9f9; padding:20px; border-radius:12px;">
                    <h3 style="margin-top:0">Categor√≠as</h3>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <input type="text" id="cat-nombre" placeholder="Nombre..." style="margin:0">
                        <button onclick="agregarCategoria()" class="btn btn-ready" style="flex:0; padding: 0 20px;">+</button>
                    </div>
                    <ul id="lista-categorias-ui" style="padding:0; list-style:none; max-height: 200px; overflow-y: auto;"></ul>
                </div>
                <div style="background:#f9f9f9; padding:20px; border-radius:12px;">
                    <h3 style="margin-top:0">Nuevo Producto</h3>
                    <input type="text" id="p-nombre" placeholder="Nombre">
                    <input type="text" id="p-desc" placeholder="Descripci√≥n">
                    <input type="number" id="p-precio" placeholder="Precio">
                    <select id="p-categoria-select"></select>
                    <button onclick="guardarProducto()" class="btn btn-ready" style="width:100%">GUARDAR PRODUCTO</button>
                </div>
            </div>
            
            <input type="text" id="buscador-prod" onkeyup="filtrarProductos()" placeholder="üîç Buscar producto en stock..." style="width:100%; padding:15px; margin-bottom:20px; border:2px solid #eee; border-radius:10px; font-size: 1rem;">
            
            <table style="width:100%; border-collapse:collapse;">
                <thead><tr><th>PRODUCTO</th><th>CATEGOR√çA</th><th>PRECIO</th><th style="text-align:center;">STOCK</th><th style="text-align:center;">ACCI√ìN</th></tr></thead>
                <tbody id="tabla-productos"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-consultas" style="display:none;">
        <div class="menu-container">
            <div style="display:flex; gap:15px; margin-bottom:25px; flex-wrap: wrap; background: #f4f4f4; padding:20px; border-radius:12px; align-items: center;">
                <input type="date" id="filtro-consulta-inicio">
                <input type="date" id="filtro-consulta-fin">
                <select id="filtro-consulta-pago" style="width: auto; margin:0;"><option value="">Todos los pagos</option><option value="transferencia">Transferencia</option><option value="efectivo">Efectivo</option></select>
                <button onclick="realizarConsultaRango()" class="btn btn-ready" style="background:var(--azul);">BUSCAR</button>
                <button onclick="descargarPDFConsulta()" class="btn btn-ready">GENERAR PDF</button>
                <div style="margin-left: auto; text-align: right;">
                    <span style="font-weight: bold; color: #888; font-size: 0.8rem;">TOTAL RANGO:</span><br>
                    <span id="total-consulta-suma" style="font-size: 1.8rem; font-weight: 900; color: var(--verde);">$0</span>
                </div>
            </div>
            <div id="contenedor-consultas" class="grid-pedidos"></div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let productosCache = [];
    let pedidosCacheConsulta = [];
    let pedidosNuevos = new Set(JSON.parse(localStorage.getItem('pedidosNuevos')) || []);

    function guardarAlertaPersistent() {
        localStorage.setItem('pedidosNuevos', JSON.stringify(Array.from(pedidosNuevos)));
        document.title = pedidosNuevos.size > 0 ? "‚ö†Ô∏è (" + pedidosNuevos.size + ") NUEVO PEDIDO" : "High Blend - Panel de Control";
    }

    // --- ESCUCHA DE SOCKETS ---
    socket.on('pedido-realizado', (data) => {
        const id = data.id || data.pedidoId;
        if(id) {
            pedidosNuevos.add(Number(id));
            guardarAlertaPersistent();
            cargarPedidos(); 
        }
    });

    socket.on('cambio-stock', (data) => {
        const index = productosCache.findIndex(p => p.id === data.id);
        if (index !== -1) {
            productosCache[index].disponible = data.disponible;
            if (document.getElementById('tab-menu').style.display === 'block') renderizarTabla(productosCache);
        }
    });

    socket.on('cambio-estado-local', (abierto) => {
        const sw = document.getElementById('switch-local');
        if(sw) sw.checked = abierto;
        const texto = document.getElementById('texto-local');
        if(texto) {
            texto.innerText = abierto ? "ABIERTO" : "CERRADO";
            texto.style.color = abierto ? "var(--verde)" : "var(--rojo)";
        }
    });

    socket.on('nuevo-producto', () => { if(document.getElementById('tab-menu').style.display === 'block') listarProductos(); });

    function detenerAlerta(id) {
        const idNum = Number(id);
        if(pedidosNuevos.has(idNum)) {
            pedidosNuevos.delete(idNum);
            guardarAlertaPersistent();
            cargarPedidos(); 
        }
    }

    function switchTab(tab) {
        const tabs = ['pedidos', 'despachados', 'menu', 'consultas'];
        tabs.forEach(t => {
            document.getElementById(`tab-${t}`).style.display = tab === t ? 'block' : 'none';
            const btn = document.getElementById(`btn-tab-${t}`);
            if (btn) btn.classList.toggle('active', tab === t);
        });
        if(tab === 'menu') { cargarCategorias(); listarProductos(); } 
        else if (tab === 'pedidos' || tab === 'despachados') { cargarPedidos(); }
    }

    async function intentarLogin() {
        const user = document.getElementById('user').value;
        const pass = document.getElementById('pass').value;
        const res = await fetch('/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user, pass }) });
        if (res.ok) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            checkEstadoLocal();
            cargarPedidos();
            setInterval(cargarPedidos, 45000);
        } else { document.getElementById('error-msg').style.display = 'block'; }
    }

    async function listarProductos() {
        const res = await fetch('/hamburguesas-admin');
        productosCache = await res.json();
        renderizarTabla(productosCache);
    }

    function renderizarTabla(lista) {
        const tabla = document.getElementById('tabla-productos');
        let html = "";
        lista.forEach(p => {
            const pData = JSON.stringify(p).replace(/'/g, "&apos;").replace(/"/g, "&quot;");
            html += `<tr style="border-bottom: 1px solid #eee;">
                <td style="padding:12px; color:#1a1a1a;"><strong>${p.nombre}</strong></td>
                <td style="color:#666;">${p.categoria}</td>
                <td style="color:#1a1a1a; font-weight:bold;">$${Number(p.precio).toLocaleString()}</td>
                <td style="text-align:center;">
                    <label class="switch">
                        <input type="checkbox" ${p.disponible ? 'checked' : ''} onchange="toggleDisponible(${p.id}, this.checked)">
                        <span class="slider"></span>
                    </label>
                </td>
                <td style="text-align:center;"><button onclick='abrirEditor(${pData})' style="color:var(--azul); background:none; border:none; cursor:pointer; font-weight:bold;">EDITAR</button></td>
            </tr>`;
        });
        tabla.innerHTML = html;
    }

    async function toggleDisponible(id, disponible) {
        const res = await fetch(`/productos/${id}/disponible`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ disponible })
        });
        if(!res.ok) { alert("Error al cambiar estado"); listarProductos(); }
    }

    async function guardarProducto() {
        const nombre = document.getElementById('p-nombre').value;
        const descripcion = document.getElementById('p-desc').value;
        const precio = document.getElementById('p-precio').value;
        const categoria = document.getElementById('p-categoria-select').value;
        if(!nombre || !precio || !categoria) return alert("Completa todos los campos");
        const res = await fetch('/productos', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre, descripcion, precio, categoria })
        });
        if(res.ok) {
            mostrarNotificacion("üçî Producto agregado");
            document.getElementById('p-nombre').value = ""; document.getElementById('p-desc').value = ""; document.getElementById('p-precio').value = "";
            listarProductos();
        }
    }

    function filtrarProductos() {
        const busqueda = document.getElementById('buscador-prod').value.toLowerCase();
        const filtrados = productosCache.filter(p => p.nombre.toLowerCase().includes(busqueda) || p.categoria.toLowerCase().includes(busqueda));
        renderizarTabla(filtrados);
    }

    async function cargarCategorias() {
        const res = await fetch('/categorias');
        const cats = await res.json();
        let html = ""; let opts = "<option disabled selected>Seleccionar categor√≠a...</option>";
        cats.forEach(c => {
            html += `<li style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee; color:#333; font-weight:bold;">
                ${c.nombre} <button onclick="eliminarCategoria(${c.id})" style="color:red; border:none; background:none; cursor:pointer; font-weight:bold; font-size:1.2rem;">√ó</button>
            </li>`;
            opts += `<option value="${c.nombre}">${c.nombre}</option>`;
        });
        document.getElementById('lista-categorias-ui').innerHTML = html || "Sin categor√≠as";
        document.getElementById('p-categoria-select').innerHTML = opts;
        document.getElementById('edit-categoria-select').innerHTML = opts;
    }

    async function agregarCategoria() {
        const nombre = document.getElementById('cat-nombre').value;
        if(!nombre) return;
        const res = await fetch('/categorias', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nombre }) });
        if(res.ok) { document.getElementById('cat-nombre').value = ""; cargarCategorias(); mostrarNotificacion("Categor√≠a agregada"); }
    }

    async function eliminarCategoria(id) {
        if(!confirm("¬øEliminar categor√≠a?")) return;
        const res = await fetch(`/categorias/${id}`, { method: 'DELETE' });
        if(res.ok) { cargarCategorias(); mostrarNotificacion("Categor√≠a eliminada"); }
    }

    async function cargarPedidos() {
        const fechaHeader = document.getElementById('filtro-fecha').value || new Date().toISOString().split('T')[0];
        const fechaDespachados = document.getElementById('filtro-fecha-despachados').value || fechaHeader;
        const resHeader = await fetch(`/pedidos/admin/lista?fecha=${fechaHeader}`);
        const pedidosHeader = await resHeader.json();
        let pedidosParaDespacho = pedidosHeader;
        if (fechaDespachados !== fechaHeader) {
            const resDespacho = await fetch(`/pedidos/admin/lista?fecha=${fechaDespachados}`);
            pedidosParaDespacho = await resDespacho.json();
        }
        const contenedorNuevos = document.getElementById('contenedor-pedidos');
        const contenedorDespachados = document.getElementById('contenedor-despachados');
        let totalVentas = 0; let htmlNuevos = ""; let htmlDespachados = "";
        pedidosHeader.forEach(p => {
            if(p.estado !== 'cancelado') totalVentas += parseFloat(p.total);
            if (p.estado !== 'enviado' && p.estado !== 'cancelado') {
                const esNuevo = pedidosNuevos.has(Number(p.id)) ? 'card-nueva' : '';
                htmlNuevos += generarCardPedido(p, esNuevo, false);
            }
        });
        pedidosParaDespacho.forEach(p => { if (p.estado === 'enviado') htmlDespachados += generarCardPedido(p, "", false); });
        contenedorNuevos.innerHTML = htmlNuevos || "<p style='color:#777; padding:20px;'>No hay pedidos pendientes.</p>";
        contenedorDespachados.innerHTML = htmlDespachados || "<p style='color:#777; padding:20px;'>No hay pedidos despachados.</p>";
        document.getElementById('stat-ventas').innerText = `$${totalVentas.toLocaleString()}`;
        document.getElementById('stat-cantidad').innerText = pedidosHeader.length;
    }

    function generarCardPedido(p, esNuevo, esConsulta) {
        const statusBadge = { 'pendiente': 'badge-pendiente', 'esperando_pago': 'badge-esperando', 'enviado': 'badge-enviado', 'cancelado': 'badge-cancelado' }[p.estado] || '';
        let botones = '';
        if (!esConsulta) {
            const btnDespachar = (p.estado === 'pendiente' || p.estado === 'esperando_pago') 
                ? `<button class="btn btn-ready" onclick="event.stopPropagation(); cambiarEstado(${p.id}, 'enviado')">DESPACHAR</button>` : '';
            const btnAnular = (p.estado !== 'cancelado') 
                ? `<button class="btn btn-cancel" onclick="event.stopPropagation(); abrirModalAnular(${p.id})">ANULAR</button>` : '';
            botones = btnDespachar + btnAnular;
        }
        return `
            <div class="card ${esNuevo}" onclick="detenerAlerta(${p.id})">
                <div class="card-header"><span>ORDEN #${p.id}</span><span class="badge ${statusBadge}">${p.estado.toUpperCase()}</span></div>
                <div class="card-body">
                    ${p.items.map(i => `<div class="item-line"><span>${i.cantidad}x ${i.nombre}</span></div>`).join('')}
                    <div class="cliente-info"><strong>üë§ ${p.cliente}</strong><br>üìç ${p.direccion}<br>üí≥ ${p.metodo_pago.toUpperCase()}<h3>$${Number(p.total).toLocaleString()}</h3></div>
                </div>
                <div class="card-footer">${botones}</div>
            </div>`;
    }

    async function cambiarEstado(id, nuevo) {
        const res = await fetch(`/pedidos/${id}/estado`, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({estado: nuevo}) });
        if(res.ok) { detenerAlerta(id); cargarPedidos(); }
    }

    async function realizarConsultaRango() {
        const inicio = document.getElementById('filtro-consulta-inicio').value;
        const fin = document.getElementById('filtro-consulta-fin').value;
        const pago = document.getElementById('filtro-consulta-pago').value;
        if(!inicio || !fin) return mostrarNotificacion("‚ö†Ô∏è Selecciona el rango");
        let fechaActual = new Date(inicio + "T00:00:00"); let fechaFin = new Date(fin + "T00:00:00");
        let todosLosPedidos = [];
        while(fechaActual <= fechaFin) {
            const fString = fechaActual.toISOString().split('T')[0];
            const res = await fetch(`/pedidos/admin/lista?fecha=${fString}`);
            const pedidosDia = await res.json();
            todosLosPedidos = todosLosPedidos.concat(pedidosDia);
            fechaActual.setDate(fechaActual.getDate() + 1);
        }
        if(pago) todosLosPedidos = todosLosPedidos.filter(p => p.metodo_pago === pago);
        pedidosCacheConsulta = todosLosPedidos;
        let totalSuma = 0; let html = "";
        todosLosPedidos.forEach(p => { if(p.estado !== 'cancelado') totalSuma += parseFloat(p.total); html += generarCardPedido(p, "", true); });
        document.getElementById('contenedor-consultas').innerHTML = html || "<p style='color:#333; padding:20px;'>Sin resultados.</p>";
        document.getElementById('total-consulta-suma').innerText = `$${totalSuma.toLocaleString()}`;
    }

    /*async function descargarPDFConsulta() {
        if (!pedidosCacheConsulta.length) return mostrarNotificacion("‚ö†Ô∏è Sin datos");
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.text("HIGH BLEND - REPORTE DE VENTAS", 105, 20, { align: 'center' });
        const rows = pedidosCacheConsulta.map(p => [p.id, p.cliente, p.metodo_pago.toUpperCase(), p.estado.toUpperCase(), `$${Number(p.total).toLocaleString()}`]);
        doc.autoTable({ startY: 30, head: [['ID', 'Cliente', 'Pago', 'Estado', 'Monto']], body: rows });
        doc.save(`Reporte_HighBlend.pdf`);
    }*/

    async function descargarPDFConsulta() {
    if (!pedidosCacheConsulta.length) return mostrarNotificacion("‚ö†Ô∏è Sin datos para exportar");

    const { jsPDF } = window.jspdf;
    // 'l' para landscape (horizontal)
    const doc = new jsPDF('l', 'mm', 'a4');
    
    // Capturamos el rango de fechas de los inputs
    const inicio = document.getElementById('filtro-consulta-inicio').value.split('-').reverse().join('/');
    const fin = document.getElementById('filtro-consulta-fin').value.split('-').reverse().join('/');

    // T√≠tulo Principal
    doc.setFontSize(20);
    doc.setTextColor(230, 57, 70); 
    doc.text("HIGH BLEND - REPORTE DE VENTAS", 148, 15, { align: 'center' });
    
    // Subt√≠tulo con Rango de Fechas
    doc.setFontSize(12);
    doc.setTextColor(60);
    doc.text(`Per√≠odo consultado: ${inicio} al ${fin}`, 148, 23, { align: 'center' });

    let totalRecaudado = 0;

    const rows = pedidosCacheConsulta.map(p => {
        if (p.estado !== 'cancelado') {
            totalRecaudado += parseFloat(p.total);
        }

        // Limpiamos la fecha para que no salga el formato ISO largo de la imagen
        // Solo tomamos DD/MM/AAAA
        let fechaLimpia = "S/D";
        if (p.fecha) {
            fechaLimpia = p.fecha.includes('T') ? p.fecha.split('T')[0] : p.fecha;
            fechaLimpia = fechaLimpia.split('-').reverse().join('/');
        }

        const productos = p.items.map(i => `${i.cantidad}x ${i.nombre}`).join(', ');

        return [
            p.id,
            fechaLimpia,
            p.cliente,
            productos,
            p.metodo_pago.toUpperCase(),
            p.estado.toUpperCase(),
            `$${Number(p.total).toLocaleString('es-AR')}`
        ];
    });

    doc.autoTable({
        startY: 30,
        head: [['ID', 'FECHA', 'CLIENTE', 'PRODUCTOS DETALLE', 'PAGO', 'ESTADO', 'MONTO']],
        body: rows,
        // Estilos para que no se amontone
        headStyles: { fillColor: [230, 57, 70], textColor: [255, 255, 255], fontSize: 10 },
        styles: { fontSize: 9, cellPadding: 4, overflow: 'linebreak' },
        columnStyles: {
            0: { cellWidth: 15 }, // ID
            1: { cellWidth: 25 }, // FECHA
            2: { cellWidth: 35 }, // CLIENTE
            3: { cellWidth: 'auto' }, // PRODUCTOS (toma el resto del espacio)
            4: { cellWidth: 30 }, // PAGO
            5: { cellWidth: 30 }, // ESTADO
            6: { cellWidth: 30, halign: 'right', fontStyle: 'bold' } // MONTO
        },
        margin: { left: 10, right: 10 },
        didDrawPage: function (data) {
            let finalY = data.cursor.y;
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            // Dibujamos el total general
            doc.text(`TOTAL RECAUDADO: $${totalRecaudado.toLocaleString('es-AR')}`, 285, finalY + 12, { align: 'right' });
        }
    });

    doc.save(`Reporte_Ventas_${inicio.replace(/\//g, '-')}_al_${fin.replace(/\//g, '-')}.pdf`);
}

    function abrirModalAnular(id) { document.getElementById('anular-id').value = id; document.getElementById('modal-anular').style.display = 'block'; }
    function cerrarModalAnular() { document.getElementById('modal-anular').style.display = 'none'; }
    async function confirmarAnulacion() {
        const id = document.getElementById('anular-id').value;
        const res = await fetch(`/pedidos/${id}/estado`, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({estado: 'cancelado'}) });
        if(res.ok) { cerrarModalAnular(); mostrarNotificacion("üö´ Pedido Anulado"); cargarPedidos(); }
    }

    async function toggleLocal(abierto) { await fetch('/admin/estado-local', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ abierto }) }); }
    async function checkEstadoLocal() {
        const res = await fetch('/estado-local'); const data = await res.json();
        document.getElementById('switch-local').checked = data.abierto;
        const texto = document.getElementById('texto-local');
        texto.innerText = data.abierto ? "ABIERTO" : "CERRADO";
        texto.style.color = data.abierto ? "var(--verde)" : "var(--rojo)";
    }

    function abrirEditor(p) {
        document.getElementById('edit-id').value = p.id; document.getElementById('edit-nombre').value = p.nombre;
        document.getElementById('edit-precio').value = p.precio; document.getElementById('edit-desc').value = p.descripcion || "";
        document.getElementById('edit-categoria-select').value = p.categoria; document.getElementById('modal-editar').style.display = 'block';
    }

    async function actualizarProducto() {
        const id = document.getElementById('edit-id').value;
        const nombre = document.getElementById('edit-nombre').value; const precio = document.getElementById('edit-precio').value;
        const descripcion = document.getElementById('edit-desc').value; const categoria = document.getElementById('edit-categoria-select').value;
        const res = await fetch(`/productos/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ nombre, descripcion, precio, categoria }) });
        if(res.ok) { cerrarModal(); listarProductos(); mostrarNotificacion("‚úÖ Actualizado"); }
    }

    function cerrarModal() { document.getElementById('modal-editar').style.display = 'none'; }
    async function logout() { await fetch('/logout', {method:'POST'}); location.reload(); }
    function mostrarNotificacion(m) { 
        const t = document.getElementById('toast'); t.innerText = m; 
        t.style.display = 'block'; setTimeout(() => t.style.display='none', 3000); 
    }

    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('filtro-fecha').value = hoy;
    document.getElementById('filtro-fecha-despachados').value = hoy;
    document.getElementById('filtro-consulta-inicio').value = hoy;
    document.getElementById('filtro-consulta-fin').value = hoy;
</script>
</body>
</html>