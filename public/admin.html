<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>High Blend - Panel de Control</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --rojo: #d32f2f; --negro: #1a1a1a; --gris-oscuro: #2d2d2d; --verde: #2e7d32; --azul: #1976d2; --naranja: #e67e22; }
        body { font-family: 'Arial', sans-serif; background: var(--negro); color: white; margin: 0; padding: 0; }
        
        #toast { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            padding: 15px 25px; 
            border-radius: 4px; 
            color: white; 
            background-color: var(--verde); 
            font-weight: bold; 
            z-index: 5000; 
            display: none; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.5); 
            animation: slideIn 0.5s; 
        }

        @keyframes parpadeo-alerta {
            0% { border: 4px solid var(--rojo); box-shadow: 0 0 10px var(--rojo); }
            50% { border: 4px solid #ffeb3b; box-shadow: 0 0 30px #ffeb3b; }
            100% { border: 4px solid var(--rojo); box-shadow: 0 0 10px var(--rojo); }
        }
        .card-nueva {
            animation: parpadeo-alerta 0.8s infinite !important;
            transform: scale(1.02);
            z-index: 100;
            cursor: pointer;
        }

        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        #login-screen { display: flex; height: 100vh; justify-content: center; align-items: center; background: var(--negro); }
        .login-box { background: white; padding: 30px; border-radius: 8px; text-align: center; width: 300px; color: #333; }
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-login { width: 100%; padding: 10px; background: var(--rojo); color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; }

        #admin-panel { display: none; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--rojo); padding-bottom: 15px; margin-bottom: 20px; }
        
        .stats { background: var(--gris-oscuro); padding: 10px 20px; border-radius: 8px; display: flex; gap: 20px; }
        .stat-item { text-align: center; }
        .stat-item span { display: block; font-size: 0.7rem; color: #aaa; text-transform: uppercase; }
        .stat-item strong { font-size: 1.2rem; color: var(--rojo); }

        .nav-tabs { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .nav-tabs button { padding: 12px 20px; cursor: pointer; background: var(--gris-oscuro); color: white; border: none; border-radius: 4px; font-weight: bold; transition: 0.3s; }
        .nav-tabs button.active { background: var(--rojo); }

        .grid-pedidos { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; width: 100%; }
        .card { background: white; color: #333; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; height: 500px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: 0.3s; border: 4px solid transparent; }
        .card-header { background: #eee; padding: 12px; display: flex; justify-content: space-between; font-weight: bold; border-bottom: 2px solid #ddd; }
        .card-body { padding: 15px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .card-footer { padding: 10px; background: #f9f9f9; display: flex; gap: 5px; }

        .item-line { border-bottom: 1px dashed #ccc; padding: 6px 0; display: flex; justify-content: space-between; }
        .cliente-info { font-size: 0.85rem; color: #666; margin-top: auto; background: #f0f0f0; padding: 10px; border-radius: 4px; border-left: 4px solid var(--rojo); }
        
        .btn { border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 1; text-transform: uppercase; font-size: 0.75rem; }
        .btn-ready { background: var(--verde); color: white; }
        .btn-cancel { background: #bbb; color: white; }
        .btn-cancel:hover { background: var(--rojo); }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; color: white; }
        .badge-pendiente { background: var(--naranja); }
        .badge-esperando { background: #f1c40f; color: #000; } 
        .badge-cancelado { background: #777; }
        .badge-enviado { background: var(--verde); }
        .status-esperando { border: 4px solid #f1c40f !important; }

        .menu-container { background: white; color: #333; padding: 25px; border-radius: 8px; }
        .search-bar { width: 100%; padding: 12px; margin-bottom: 20px; border: 2px solid #eee; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--verde); }
        input:checked + .slider:before { transform: translateX(14px); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 4000; }
        .modal-content { background: white; color: #333; width: 90%; max-width: 400px; margin: 50px auto; padding: 25px; border-radius: 8px; box-sizing: border-box; }

        .panel-filtros-box { background: #f4f4f4; padding: 15px; border-radius: 6px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; border: 1px solid #ddd; align-items: end; }
        .panel-filtros-box label { display: block; font-size: 0.75rem; color: #666; margin-bottom: 4px; font-weight: bold; }
        .panel-filtros-box input, .panel-filtros-box select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="toast"></div>

<div id="modal-anular" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h3 style="margin-top:0; color: var(--rojo);">‚ö†Ô∏è ¬øAnular Pedido?</h3>
        <p>Esta acci√≥n marcar√° el pedido como CANCELADO y no se sumar√° a las ventas.</p>
        <input type="hidden" id="anular-id">
        <button onclick="confirmarAnulacion()" style="background:var(--rojo); color:white; border:none; padding:12px; width:100%; border-radius:4px; font-weight:bold; cursor:pointer;">S√ç, ANULAR PEDIDO</button>
        <button style="background:#ccc; border:none; width:100%; padding:10px; margin-top:10px; cursor:pointer; border-radius:4px;" onclick="cerrarModalAnular()">CANCELAR</button>
    </div>
</div>

<div id="modal-editar" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color: var(--azul);">Editar Producto</h3>
        <input type="hidden" id="edit-id">
        <label>Nombre:</label><input type="text" id="edit-nombre" style="width:100%; padding:8px; margin-bottom:10px;">
        <label>Precio ($):</label><input type="number" id="edit-precio" style="width:100%; padding:8px; margin-bottom:10px;">
        <label>Categor√≠a:</label><select id="edit-categoria-select" style="width:100%; padding:8px; margin-bottom:10px;"></select>
        <label>Descripci√≥n:</label><input type="text" id="edit-desc" style="width:100%; padding:8px; margin-bottom:10px;">
        <button onclick="actualizarProducto()" style="background:var(--verde); color:white; border:none; padding:12px; width:100%; border-radius:4px; font-weight:bold; cursor:pointer;">GUARDAR CAMBIOS</button>
        <button style="background:#ccc; border:none; width:100%; padding:10px; margin-top:10px; cursor:pointer; border-radius:4px;" onclick="cerrarModal()">CANCELAR</button>
    </div>
</div>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color: var(--rojo); margin-top: 0;">HIGH BLEND ADMIN</h2>
        <input type="text" id="user" placeholder="Usuario">
        <input type="password" id="pass" placeholder="Contrase√±a">
        <button class="btn-login" onclick="intentarLogin()">ENTRAR</button>
        <p id="error-msg" style="color: red; display: none; font-size: 0.8rem; margin-top: 10px;">Usuario o clave incorrectos</p>
    </div>
</div>

<div id="admin-panel">
    <header>
        <div style="background: var(--gris-oscuro); padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
            <span>ESTADO DEL LOCAL:</span>
            <label class="switch">
                <input type="checkbox" id="switch-local" checked onchange="toggleLocal(this.checked)">
                <span class="slider"></span>
            </label>
            <strong id="texto-local" style="color: var(--verde);">ABIERTO</strong>
        </div>
        <div>
            <h2 style="margin:0">CONTROL DE COCINA üë®‚Äçüç≥</h2>
            <input type="date" id="filtro-fecha" onchange="cargarPedidos()" style="padding: 8px; margin-top: 10px; border-radius: 4px;">
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="stats">
                <div class="stat-item"><span>Venta del D√≠a</span><strong id="stat-ventas">$0</strong></div>
                <div class="stat-item"><span>Total Pedidos</span><strong id="stat-cantidad">0</strong></div>
            </div>
            <button onclick="logout()" style="background: none; border: 1px solid white; color: white; padding: 8px 15px; cursor: pointer; border-radius: 4px;">Salir</button>
        </div>
    </header>

    <div class="nav-tabs">
        <button id="btn-tab-pedidos" class="active" onclick="switchTab('pedidos')">üì¶ NUEVOS PEDIDOS</button>
        <button id="btn-tab-despachados" onclick="switchTab('despachados')" style="background: var(--verde);">‚úÖ DESPACHADOS</button>
        <button id="btn-tab-menu" onclick="switchTab('menu')">üçî GESTIONAR MEN√ö</button>
        <button id="btn-tab-consultas" style="background: var(--azul);" onclick="switchTab('consultas')">üîç CONSULTAS</button>
    </div>

    <div id="tab-pedidos">
        <div class="grid-pedidos" id="contenedor-pedidos"></div>
    </div>

    <div id="tab-despachados" style="display: none;">
        <div class="grid-pedidos" id="contenedor-despachados"></div>
    </div>

    <div id="tab-menu" style="display: none;">
        <div class="menu-container">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <div style="background: #f4f4f4; padding: 20px; border-radius: 8px;">
                    <h3>üìÅ Categor√≠as</h3>
                    <div style="display: flex; gap: 5px; margin-bottom: 15px;">
                        <input type="text" id="cat-nombre" placeholder="Nueva..." style="flex:1; padding: 8px;">
                        <button onclick="agregarCategoria()" style="background:var(--azul); color:white; border:none; padding:10px 15px; cursor:pointer; border-radius:4px;">+</button>
                    </div>
                    <ul id="lista-categorias-ui" style="list-style:none; padding:0; color:#333; max-height: 150px; overflow-y: auto;"></ul>
                </div>
                <div>
                    <h3>+ Nuevo Producto</h3>
                    <input type="text" id="p-nombre" placeholder="Nombre" style="width:100%; padding:8px; margin-bottom:5px;">
                    <input type="text" id="p-desc" placeholder="Descripci√≥n" style="width:100%; padding:8px; margin-bottom:5px;">
                    <input type="number" id="p-precio" placeholder="Precio" style="width:100%; padding:8px; margin-bottom:5px;">
                    <select id="p-categoria-select" style="width:100%; padding:8px; margin-bottom:5px;"></select>
                    <button onclick="guardarProducto()" style="background: var(--verde); color: white; border: none; padding: 12px; width:100%; cursor: pointer; font-weight: bold; border-radius: 4px;">GUARDAR</button>
                </div>
            </div>
            <input type="text" id="buscador-prod" placeholder="üîç Buscar..." class="search-bar" onkeyup="filtrarProductos()">
            <table style="width: 100%; border-collapse: collapse; text-align: left; color:#333;">
                <thead><tr style="background: #f4f4f4;"><th style="padding:12px;">Nombre</th><th>Categor√≠a</th><th>Precio</th><th style="text-align:center;">Stock</th><th style="text-align:center;">Acci√≥n</th></tr></thead>
                <tbody id="tabla-productos"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-consultas" style="display: none;">
        <div class="menu-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin:0">üîç Rango de Consultas</h3>
                <div style="background: var(--negro); padding: 10px 20px; border-radius: 6px; border: 1px solid var(--azul); display: flex; align-items: center;">
                    <span style="font-size: 0.8rem; color: #aaa;">TOTAL EN RANGO:</span>
                    <strong id="total-consulta-suma" style="color: var(--azul); font-size: 1.3rem; margin-left: 10px;">$0</strong>
                    <button onclick="descargarPDFConsulta()" style="margin-left:15px; background:var(--verde); color:white; border:none; padding:5px 10px; cursor:pointer; border-radius:4px; font-size:0.8rem; font-weight: bold;">PDF üì•</button>
                </div>
            </div>
            <div class="panel-filtros-box">
                <div>
                    <label>Desde:</label>
                    <input type="date" id="filtro-consulta-inicio">
                </div>
                <div>
                    <label>Hasta:</label>
                    <input type="date" id="filtro-consulta-fin">
                </div>
                <div>
                    <label>M√©todo Pago:</label>
                    <select id="filtro-consulta-pago">
                        <option value="">Todos</option>
                        <option value="efectivo">Efectivo</option>
                        <option value="transferencia">Transferencia</option>
                    </select>
                </div>
                <button onclick="realizarConsultaRango()" style="background:var(--azul); color:white; border:none; padding:10px; border-radius:4px; font-weight:bold; cursor:pointer; height: 38px;">BUSCAR</button>
            </div>
            <div class="grid-pedidos" id="contenedor-consultas"></div>
        </div>
    </div>
</div>

<script>
    const socket = io();
    let productosCache = [];
    let pedidosCacheConsulta = [];
    let pedidosNuevos = new Set(JSON.parse(localStorage.getItem('pedidosNuevos')) || []);

    function guardarAlertaPersistent() {
        localStorage.setItem('pedidosNuevos', JSON.stringify(Array.from(pedidosNuevos)));
        document.title = pedidosNuevos.size > 0 ? "‚ö†Ô∏è NUEVO PEDIDO ‚ö†Ô∏è" : "High Blend - Panel de Control";
    }

    socket.on('pedido-realizado', (data) => {
        const id = data.id || data.pedidoId;
        if(id) {
            pedidosNuevos.add(Number(id));
            guardarAlertaPersistent();
            cargarPedidos(); 
        }
    });

    function detenerAlerta(id) {
        const idNum = Number(id);
        if(pedidosNuevos.has(idNum)) {
            pedidosNuevos.delete(idNum);
            guardarAlertaPersistent();
            cargarPedidos(); 
        }
    }

    function switchTab(tab) {
        const tabs = ['pedidos', 'despachados', 'menu', 'consultas'];
        tabs.forEach(t => {
            document.getElementById(`tab-${t}`).style.display = tab === t ? 'block' : 'none';
            const btn = document.getElementById(`btn-tab-${t}`);
            if (btn) btn.classList.toggle('active', tab === t);
        });

        if(tab === 'menu') { cargarCategorias(); listarProductos(); } 
        else if (tab === 'pedidos' || tab === 'despachados') { cargarPedidos(); }
    }

    async function intentarLogin() {
        const user = document.getElementById('user').value;
        const pass = document.getElementById('pass').value;
        const res = await fetch('/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user, pass }) });
        if (res.ok) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            checkEstadoLocal();
            cargarPedidos();
            setInterval(cargarPedidos, 45000);
        } else { document.getElementById('error-msg').style.display = 'block'; }
    }

    async function listarProductos() {
        const res = await fetch('/hamburguesas-admin');
        productosCache = await res.json();
        renderizarTabla(productosCache);
    }

    function renderizarTabla(lista) {
        const tabla = document.getElementById('tabla-productos');
        let html = "";
        lista.forEach(p => {
            const pData = JSON.stringify(p).replace(/'/g, "&apos;").replace(/"/g, "&quot;");
            html += `<tr style="border-bottom: 1px solid #eee;">
                <td style="padding:12px;"><strong>${p.nombre}</strong></td>
                <td>${p.categoria}</td>
                <td>$${Number(p.precio).toLocaleString()}</td>
                <td style="text-align:center;"><label class="switch"><input type="checkbox" ${p.disponible ? 'checked' : ''} onchange="toggleDisponible(${p.id}, this.checked)"><span class="slider"></span></label></td>
                <td style="text-align:center;"><button onclick='abrirEditor(${pData})' style="color:var(--azul); background:none; border:none; cursor:pointer;">Editar</button></td>
            </tr>`;
        });
        tabla.innerHTML = html;
    }

    async function cargarPedidos() {
        const fecha = document.getElementById('filtro-fecha').value || new Date().toISOString().split('T')[0];
        const res = await fetch(`/pedidos/admin/lista?fecha=${fecha}`);
        const pedidos = await res.json();

        const contenedorNuevos = document.getElementById('contenedor-pedidos');
        const contenedorDespachados = document.getElementById('contenedor-despachados');
        
        let totalVentas = 0;
        let htmlNuevos = "";
        let htmlDespachados = "";

        pedidos.forEach(p => {
            if(p.estado !== 'cancelado') totalVentas += parseFloat(p.total);
            
            const esNuevo = pedidosNuevos.has(Number(p.id)) ? 'card-nueva' : '';
            const cardHtml = generarCardPedido(p, esNuevo);

            if (p.estado === 'enviado') {
                htmlDespachados += cardHtml;
            } else if (p.estado !== 'cancelado') {
                htmlNuevos += cardHtml;
            }
        });
        
        contenedorNuevos.innerHTML = htmlNuevos || "<p style='color:#777; padding:20px;'>No hay pedidos pendientes.</p>";
        contenedorDespachados.innerHTML = htmlDespachados || "<p style='color:#777; padding:20px;'>No hay pedidos despachados hoy.</p>";
        
        document.getElementById('stat-ventas').innerText = `$${totalVentas.toLocaleString()}`;
        document.getElementById('stat-cantidad').innerText = pedidos.length;
        document.title = pedidosNuevos.size > 0 ? "‚ö†Ô∏è NUEVO PEDIDO ‚ö†Ô∏è" : "High Blend - Panel de Control";
    }

    function generarCardPedido(p, esNuevo) {
        const statusBadge = {
            'pendiente': 'badge-pendiente',
            'esperando_pago': 'badge-esperando',
            'enviado': 'badge-enviado',
            'cancelado': 'badge-cancelado'
        }[p.estado] || '';
        
        return `
            <div class="card ${esNuevo} ${p.estado === 'esperando_pago' ? 'status-esperando' : ''}" onclick="detenerAlerta(${p.id})">
                <div class="card-header"><span>#${p.id}</span><span class="badge ${statusBadge}">${p.estado.toUpperCase()}</span></div>
                <div class="card-body">
                    ${p.items.map(i => `<div class="item-line"><span>${i.cantidad}x ${i.nombre}</span></div>`).join('')}
                    <div class="cliente-info"><strong>üë§ ${p.cliente}</strong><br>üìç ${p.direccion}<br>üí≥ ${p.metodo_pago}<h3>$${Number(p.total).toLocaleString()}</h3></div>
                </div>
                <div class="card-footer">
                    ${p.estado === 'pendiente' || p.estado === 'esperando_pago' ? `<button class="btn btn-ready" onclick="event.stopPropagation(); cambiarEstado(${p.id}, 'enviado')">DESPACHAR</button>` : ''}
                    ${p.estado !== 'cancelado' ? `<button class="btn btn-cancel" onclick="event.stopPropagation(); abrirModalAnular(${p.id})">ANULAR</button>` : ''}
                </div>
            </div>`;
    }

    async function cambiarEstado(id, nuevo) {
        const res = await fetch(`/pedidos/${id}/estado`, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({estado: nuevo}) });
        if(res.ok) {
            detenerAlerta(id);
            mostrarNotificacion(nuevo === 'enviado' ? "üöÄ Pedido Despachado" : "Actualizado");
            cargarPedidos();
        }
    }

    async function realizarConsultaRango() {
        const inicio = document.getElementById('filtro-consulta-inicio').value;
        const fin = document.getElementById('filtro-consulta-fin').value;
        const pago = document.getElementById('filtro-consulta-pago').value;

        if(!inicio || !fin) return mostrarNotificacion("‚ö†Ô∏è Selecciona ambas fechas");

        let fechaActual = new Date(inicio + "T00:00:00");
        let fechaFin = new Date(fin + "T00:00:00");
        let todosLosPedidos = [];

        while(fechaActual <= fechaFin) {
            const fString = fechaActual.toISOString().split('T')[0];
            try {
                const res = await fetch(`/pedidos/admin/lista?fecha=${fString}`);
                const pedidosDia = await res.json();
                todosLosPedidos = todosLosPedidos.concat(pedidosDia);
            } catch(e) { console.error("Error cargando d√≠a", fString); }
            fechaActual.setDate(fechaActual.getDate() + 1);
        }

        if(pago) todosLosPedidos = todosLosPedidos.filter(p => p.metodo_pago === pago);
        pedidosCacheConsulta = todosLosPedidos;

        let totalSuma = 0;
        let html = "";
        todosLosPedidos.forEach(p => {
            if(p.estado !== 'cancelado') totalSuma += parseFloat(p.total);
            html += generarCardPedido(p, "");
        });

        document.getElementById('contenedor-consultas').innerHTML = html || "<p style='color:#333; padding:20px;'>Sin resultados en este rango.</p>";
        document.getElementById('total-consulta-suma').innerText = `$${totalSuma.toLocaleString()}`;
    }

    async function descargarPDFConsulta() {
        if (!pedidosCacheConsulta || pedidosCacheConsulta.length === 0) return mostrarNotificacion("‚ö†Ô∏è Realiza una b√∫squeda primero");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const inicio = document.getElementById('filtro-consulta-inicio').value;
        const fin = document.getElementById('filtro-consulta-fin').value;
        doc.setFontSize(20);
        doc.setTextColor(211, 47, 47);
        doc.text("REPORTES HIGH BLEND", 105, 20, { align: 'center' });
        doc.setFontSize(12);
        doc.setTextColor(40);
        doc.text(`Periodo: ${inicio} al ${fin}`, 14, 30);
        doc.text(`Total: ${document.getElementById('total-consulta-suma').innerText}`, 14, 37);
        const rows = pedidosCacheConsulta.map(p => [p.id, p.cliente, p.metodo_pago.toUpperCase(), p.estado.toUpperCase(), `$${Number(p.total).toLocaleString()}`]);
        doc.autoTable({ startY: 50, head: [['ID', 'Cliente', 'Pago', 'Estado', 'Monto']], body: rows, headStyles: { fillColor: [211, 47, 47] } });
        doc.save(`Reporte_Ventas_${inicio}_${fin}.pdf`);
    }

    function abrirModalAnular(id) {
        document.getElementById('anular-id').value = id;
        document.getElementById('modal-anular').style.display = 'block';
    }

    function cerrarModalAnular() {
        document.getElementById('modal-anular').style.display = 'none';
    }

    async function confirmarAnulacion() {
        const id = document.getElementById('anular-id').value;
        const res = await fetch(`/pedidos/${id}/estado`, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({estado: 'cancelado'}) });
        if(res.ok) {
            cerrarModalAnular();
            mostrarNotificacion("üö´ Pedido Anulado");
            cargarPedidos();
        }
    }

    async function cargarCategorias() {
        const res = await fetch('/categorias');
        const cats = await res.json();
        let html = ""; let opts = "<option disabled selected>Categor√≠a...</option>";
        cats.forEach(c => {
            html += `<li style="display:flex; justify-content:space-between; padding:5px 0;">${c.nombre}<button onclick="eliminarCategoria(${c.id})" style="color:red; border:none; background:none; cursor:pointer;">√ó</button></li>`;
            opts += `<option value="${c.nombre}">${c.nombre}</option>`;
        });
        document.getElementById('lista-categorias-ui').innerHTML = html;
        document.getElementById('p-categoria-select').innerHTML = opts;
        document.getElementById('edit-categoria-select').innerHTML = opts;
    }

    async function toggleLocal(abierto) {
        const res = await fetch('/admin/estado-local', { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ abierto }) });
        if (res.ok) {
            const texto = document.getElementById('texto-local');
            texto.innerText = abierto ? "ABIERTO" : "CERRADO";
            texto.style.color = abierto ? "var(--verde)" : "var(--rojo)";
            mostrarNotificacion(abierto ? "Local Abierto" : "Local Cerrado");
        }
    }

    async function checkEstadoLocal() {
        const res = await fetch('/estado-local');
        const data = await res.json();
        document.getElementById('switch-local').checked = data.abierto;
        document.getElementById('texto-local').innerText = data.abierto ? "ABIERTO" : "CERRADO";
        document.getElementById('texto-local').style.color = data.abierto ? "var(--verde)" : "var(--rojo)";
    }

    function mostrarNotificacion(m) { 
        const t = document.getElementById('toast'); 
        t.innerText = m; 
        t.style.display = 'block'; 
        setTimeout(() => t.style.display='none', 3000); 
    }

    function abrirEditor(p) {
        document.getElementById('edit-id').value = p.id;
        document.getElementById('edit-nombre').value = p.nombre;
        document.getElementById('edit-precio').value = p.precio;
        document.getElementById('edit-desc').value = p.descripcion || "";
        document.getElementById('edit-categoria-select').value = p.categoria;
        document.getElementById('modal-editar').style.display = 'block';
    }

    async function actualizarProducto() {
        const id = document.getElementById('edit-id').value;
        const nombre = document.getElementById('edit-nombre').value;
        const precio = document.getElementById('edit-precio').value;
        const descripcion = document.getElementById('edit-desc').value;
        const categoria = document.getElementById('edit-categoria-select').value;
        const res = await fetch(`/productos/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ nombre, descripcion, precio, categoria }) });
        if(res.ok) { cerrarModal(); listarProductos(); mostrarNotificacion("‚úÖ Actualizado"); }
    }

    function cerrarModal() { document.getElementById('modal-editar').style.display = 'none'; }
    async function logout() { await fetch('/logout', {method:'POST'}); location.reload(); }

    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('filtro-fecha').value = hoy;
    document.getElementById('filtro-consulta-inicio').value = hoy;
    document.getElementById('filtro-consulta-fin').value = hoy;
</script>
</body>
</html>