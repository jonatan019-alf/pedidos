<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>High Blend - Pedidos</title>
    <style>
        :root { --rojo: #d32f2f; --negro: #1a1a1a; --gris-fondo: #f4f4f4; --verde: #2e7d32; --azul: #1976d2; }
        body { font-family: 'Arial', sans-serif; background: var(--gris-fondo); margin: 0; padding: 0; }
        header { background: white; padding: 15px; text-align: center; border-bottom: 3px solid var(--rojo); }
        header h2 { margin: 0; color: var(--rojo); text-transform: uppercase; font-size: 1.5rem; }
        
        .container { max-width: 600px; margin: 0 auto; padding: 15px; padding-bottom: 130px; }
        .cat-header { background: #e67e22; color: white; padding: 10px; border-radius: 4px; margin: 20px 0 10px; font-weight: bold; text-transform: uppercase; }
        .item-card { background: white; padding: 15px; margin-bottom: 2px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--rojo); border-bottom: 1px solid #eee; }
        .item-info strong { font-size: 1.1rem; text-transform: uppercase; display: block; }
        .item-info p { color: #666; font-size: 0.9rem; margin: 4px 0; }
        .precio { color: var(--negro); font-weight: bold; font-size: 1.1rem; display: block; margin-top: 5px; }
        
        /* Contenedor de botones ajustado */
        .btn-container { display: flex; align-items: center; gap: 0; background: #eee; border-radius: 8px; overflow: hidden; height: 40px; }
        .btn-add-initial { background: var(--rojo); color: white; border: none; padding: 0 15px; height: 40px; border-radius: 8px; font-weight: bold; text-transform: uppercase; cursor: pointer; font-size: 0.8rem; }
        
        /* Controles de cantidad */
        .qty-controls { display: none; align-items: center; background: #eee; height: 40px; }
        .btn-qty { background: var(--negro); color: white; border: none; width: 35px; height: 40px; font-size: 1.2rem; font-weight: bold; cursor: pointer; }
        .btn-qty:active { opacity: 0.7; }
        .qty-num { width: 35px; text-align: center; font-weight: bold; color: var(--negro); font-size: 1rem; }

        .floating-cart { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 450px; background: var(--negro); color: white; 
            border-radius: 15px; display: none; flex-direction: column;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.4); z-index: 1000; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
            overflow: hidden; max-height: 65px;
        }

        .floating-cart.expanded {
            max-height: 85vh; bottom: 0; width: 100%; max-width: 100%; border-radius: 25px 25px 0 0;
        }

        .drag-handle { width: 40px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin: 8px auto 2px; display: block; }
        .cart-header-click { display: flex; justify-content: space-between; align-items: center; padding: 5px 25px 15px; cursor: pointer; width: 100%; box-sizing: border-box; }
        .cart-content-area { padding: 0 20px 25px; overflow-y: auto; display: none; flex-direction: column; background: var(--negro); height: 100%; }
        .floating-cart.expanded .cart-content-area { display: flex; }

        #items-detalle { max-height: 200px; overflow-y: auto; margin-bottom: 10px; border-bottom: 1px solid #333; }
        .cart-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #222; }
        .btn-remove { background: var(--rojo); color: white; border: none; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 2000; overflow-y: auto; }
        .modal-content { background: white; margin: 10% auto; width: 92%; max-width: 450px; padding: 25px; border-radius: 12px; position: relative; color: #1a1a1a; box-sizing: border-box; }
        
        .input-group input, .input-group select { width: 100%; padding: 14px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .total-container { margin: 10px 0; padding: 10px 0; text-align: right; }
        .total-text { font-size: 1.5rem; font-weight: bold; color: #fff; }
        
        .btn-finalizar { background: var(--verde); color: white; width: 100%; padding: 18px; border: none; border-radius: 8px; font-weight: bold; text-transform: uppercase; cursor: pointer; font-size: 1.1rem; }
        .btn-cerrar-exp { background: transparent; color: #aaa; width: 100%; padding: 12px; border: 1px solid #444; border-radius: 8px; margin-top: 12px; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; }

        .success-card { text-align: center; }
        .success-icon { font-size: 50px; color: var(--verde); margin-bottom: 10px; }
        .ticket-detail { background: #f9f9f9; padding: 15px; border-radius: 6px; text-align: left; margin: 15px 0; font-family: monospace; border: 1px dashed #ccc; color: #333; font-size: 0.9rem; }
        
        .btn-whatsapp { 
            background: #25d366; color: white; width: 100%; padding: 18px; 
            border: none; border-radius: 8px; font-weight: bold; text-decoration: none; 
            display: flex; align-items: center; justify-content: center; 
            margin: 20px auto 5px; text-align: center; box-sizing: border-box;
            font-size: 1.1rem; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        }

        .info-pago-extra { background: #e8f5e9; padding: 15px; border-radius: 8px; font-size: 0.95rem; margin-bottom: 15px; border: 1px solid #c8e6c9; color: #2e7d32; }
    </style>
</head>
<body>

<header>
    <h2>NUESTRO MEN√ö üçî</h2>
</header>

<div class="container" id="lista-menu"></div>

<div class="floating-cart" id="btn-ver-carrito">
    <div onclick="toggleCartExpand()">
        <span class="drag-handle"></span>
        <div class="cart-header-click">
            <span style="font-weight: bold;" id="label-carrito">Ver pedido (<span id="cart-count">0</span>)</span>
            <span id="cart-total-footer" style="font-weight: bold; font-size: 1.2rem;">$0</span>
        </div>
    </div>
    
    <div class="cart-content-area">
        <div id="items-detalle"></div>
        <div class="total-container">
            <span class="total-text">TOTAL: <span id="total-expandido">$0</span></span>
        </div>
        
        <div class="input-group" style="background: #222; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
             <select id="tipo_entrega" onchange="toggleEntrega()">
                <option value="delivery">Delivery</option>
                <option value="retiro">Retiro en local</option>
            </select>
            <select id="metodo_pago">
                <option value="efectivo">Efectivo</option>
                <option value="transferencia">Transferencia</option>
            </select>
            <input type="text" id="nombre" placeholder="¬øA nombre de qui√©n?">
            <input type="text" id="direccion" placeholder="Direcci√≥n de entrega">
            <input type="tel" id="tel" placeholder="Tel√©fono (WhatsApp)">
        </div>

        <button class="btn-finalizar" id="btn-procesar" onclick="enviarPedido()">FINALIZAR COMPRA</button>
        <button class="btn-cerrar-exp" onclick="toggleCartExpand()">‚áä Volver al men√∫</button>
    </div>
</div>

<div class="modal" id="modal-exito">
    <div class="modal-content success-card">
        <div class="success-icon">‚úî</div>
        <h2 style="color: var(--verde); margin: 0;">¬°PEDIDO RECIBIDO!</h2>
        <p>Orden <strong>#<span id="res-pedido-id"></span></strong> enviada correctamente.</p>
        <div class="ticket-detail" id="ticket-final"></div>
        <div id="contenedor-info-extra" class="info-pago-extra" style="display:none;">
            <div id="info-transferencia" style="display:none;">
                <strong>DATOS DE TRANSFERENCIA:</strong><br>
                ALIAS: <strong>HighBlend.Burgers</strong><br>
                CVU: <strong>00000031000...</strong><br>
                <p style="margin-top:10px; font-weight:bold; color:var(--rojo)">‚ö†Ô∏è Esperamos tu comprobante por WhatsApp para iniciar el pedido.</p>
            </div>
            <div id="info-retiro" style="display:none;">
                <strong>üìç RETIRO EN LOCAL:</strong><br>
                ¬°Te esperamos en el local para entregarte tu pedido!
            </div>
        </div>
        <a href="#" id="link-wsp" target="_blank" class="btn-whatsapp">CONFIRMAR POR WHATSAPP</a>
    </div>
</div>

<div class="modal" id="modal-cerrado">
    <div class="modal-content success-card">
        <div style="font-size:60px">üõë</div>
        <h2 style="color: var(--rojo);">LOCAL CERRADO</h2>
        <p>En este momento no estamos recibiendo pedidos.</p>
        <button class="btn-add-initial" style="width:100%" onclick="toggleModal('modal-cerrado', false)">ENTENDIDO</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let carrito = [];
    const ORDEN_PRIORIDAD = ['PROMOCIONES', 'CLASICAS', 'ESPECIALES', 'PAPAS', 'BEBIDAS', 'CERVEZAS', 'MEDALLONES', 'SALSAS', 'HEINZ', 'TOPPINGS'];

    socket.on('nuevo-producto', () => cargar());
    socket.on('nueva-categoria', () => cargar());
    socket.on('producto-eliminado', () => cargar());
    socket.on('categoria-eliminada', () => cargar());
    socket.on('cambio-estado-local', (abierto) => abierto ? toggleModal('modal-cerrado', false) : toggleModal('modal-cerrado', true));

    // AQU√ç AGREGAS EL NUEVO:
    socket.on('cambio-stock', (data) => {
        const productoCard = document.getElementById(`prod-${data.id}`);
        if (productoCard) productoCard.style.display = data.disponible ? 'flex' : 'none';
    });
    async function verificarEstadoInicial() {
        try {
            const res = await fetch('/estado-local');
            const data = await res.json();
            if (!data.abierto) toggleModal('modal-cerrado', true);
        } catch (e) { console.error(e); }
    }

    async function cargar() {
        verificarEstadoInicial();
        try {
            const [resProd, resCat] = await Promise.all([fetch('/hamburguesas'), fetch('/categorias')]);
            const productos = await resProd.json();
            const categoriasDB = await resCat.json();
            
            let categoriasNombres = categoriasDB.map(c => c.nombre);
            let ordenFinal = [...ORDEN_PRIORIDAD.filter(cat => categoriasNombres.includes(cat)), ...categoriasNombres.filter(cat => !ORDEN_PRIORIDAD.includes(cat))];

            const div = document.getElementById('lista-menu');
            div.innerHTML = '';

            ordenFinal.forEach(nombreCat => {
                const productosDeEstaCat = productos.filter(h => h.categoria === nombreCat);
                if(productosDeEstaCat.length > 0) {
                    div.innerHTML += `<div class="cat-header">${nombreCat}</div>`;
                    productosDeEstaCat.forEach(h => {
                        const displayStyle = h.disponible ? 'flex' : 'none';
                        div.innerHTML += `
                            <div class="item-card" id="prod-${h.id}" style="display: ${displayStyle}">
                                <div class="item-info">
                                    <strong>${h.nombre}</strong>
                                    <p>${h.descripcion || ''}</p>
                                    <span class="precio">$${Number(h.precio).toLocaleString('es-AR')}</span>
                                </div>
                                <div class="btn-container" id="cont-${h.id}">
                                    <button class="btn-add-initial" id="btn-init-${h.id}" onclick="agregar(${h.id}, '${h.nombre}', ${h.precio})">AGREGAR</button>
                                    <div class="qty-controls" id="qty-ctrl-${h.id}">
                                        <button class="btn-qty" onclick="restar(${h.id})">‚àí</button>
                                        <span class="qty-num" id="qty-val-${h.id}">0</span>
                                        <button class="btn-qty" onclick="agregar(${h.id}, '${h.nombre}', ${h.precio})">+</button>
                                    </div>
                                </div>
                            </div>`;
                    });
                }
            });
            actualizarUI();
        } catch (e) { console.error(e); }
    }

    function agregar(id, nombre, precio) {
        const item = carrito.find(p => p.hamburguesa_id === id);
        if (item) {
            item.cantidad++;
        } else {
            carrito.push({hamburguesa_id: id, nombre, precio, cantidad: 1});
        }
        actualizarUI();
    }

    function restar(id) {
        const index = carrito.findIndex(p => p.hamburguesa_id === id);
        if (index !== -1) {
            if (carrito[index].cantidad > 1) {
                carrito[index].cantidad--;
            } else {
                carrito.splice(index, 1);
            }
        }
        actualizarUI();
    }

    function eliminar(index) {
        carrito.splice(index, 1);
        actualizarUI();
    }

    function actualizarUI() {
        const bar = document.getElementById('btn-ver-carrito');
        const count = document.getElementById('cart-count');
        const totalFooter = document.getElementById('cart-total-footer');
        const totalExpandido = document.getElementById('total-expandido');
        const detalle = document.getElementById('items-detalle');
        let total = 0; let unidades = 0;
        detalle.innerHTML = '';

        // Resetear todos los controles de la lista a estado inicial
        document.querySelectorAll('.btn-add-initial').forEach(b => b.style.display = 'block');
        document.querySelectorAll('.qty-controls').forEach(b => b.style.display = 'none');

        carrito.forEach((p, index) => {
            total += p.precio * p.cantidad; 
            unidades += p.cantidad;
            
            // Dibujar en el carrito flotante
            detalle.innerHTML += `
                <div class="cart-list-item">
                    <span>${p.cantidad}x ${p.nombre}</span>
                    <div style="display:flex; align-items:center;">
                        <strong style="margin-right:10px;">$${(p.precio * p.cantidad).toLocaleString('es-AR')}</strong>
                        <button class="btn-remove" onclick="eliminar(${index})">‚úï</button>
                    </div>
                </div>`;
            
            // Actualizar botones en la lista del men√∫
            const btnInit = document.getElementById(`btn-init-${p.hamburguesa_id}`);
            const qtyCtrl = document.getElementById(`qty-ctrl-${p.hamburguesa_id}`);
            const qtyVal = document.getElementById(`qty-val-${p.hamburguesa_id}`);
            
            if(btnInit && qtyCtrl) {
                btnInit.style.display = 'none';
                qtyCtrl.style.display = 'flex';
                qtyVal.innerText = p.cantidad;
            }
        });

        bar.style.display = unidades > 0 ? 'flex' : 'none';
        count.innerText = unidades;
        totalFooter.innerText = `$${total.toLocaleString('es-AR')}`;
        totalExpandido.innerText = `$${total.toLocaleString('es-AR')}`;
        if(unidades === 0) bar.classList.remove('expanded');
    }

    function toggleCartExpand() {
        const cart = document.getElementById('btn-ver-carrito');
        cart.classList.toggle('expanded');
        document.getElementById('label-carrito').innerText = cart.classList.contains('expanded') ? "üõí Tu Pedido" : `Ver pedido (${document.getElementById('cart-count').innerText})`;
    }

    function toggleEntrega() {
        const tipo = document.getElementById('tipo_entrega').value;
        const inputDir = document.getElementById('direccion');
        inputDir.style.display = tipo === 'retiro' ? 'none' : 'block';
        inputDir.value = tipo === 'retiro' ? 'RETIRO EN LOCAL' : '';
    }

    function toggleModal(id, show) { document.getElementById(id).style.display = show ? 'block' : 'none'; }

    async function enviarPedido() {
        const resEstado = await fetch('/estado-local');
        const dataEstado = await resEstado.json();
        if (!dataEstado.abierto) return toggleModal('modal-cerrado', true);

        const inputs = {
            nombre: document.getElementById('nombre'),
            dir: document.getElementById('direccion'),
            tel: document.getElementById('tel'),
            pago: document.getElementById('metodo_pago'),
            entrega: document.getElementById('tipo_entrega')
        };

        if(!inputs.nombre.value || !inputs.dir.value || !inputs.tel.value) return alert("Completa tus datos");
        
        const btn = document.getElementById('btn-procesar');
        btn.disabled = true; btn.innerText = "PROCESANDO...";

        try {
            const res = await fetch('/pedidos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    cliente: inputs.nombre.value, direccion: inputs.dir.value, 
                    telefono: inputs.tel.value, tipo_entrega: inputs.entrega.value,
                    metodo_pago: inputs.pago.value, items: carrito 
                })
            });

            if(res.ok) {
                const datos = await res.json();
                socket.emit('pedido-realizado', { id: datos.pedidoId });
                mostrarExito(datos, inputs.nombre.value, inputs.dir.value, inputs.pago.value, inputs.entrega.value);
            } else {
                alert("Error al enviar pedido");
                btn.disabled = false; btn.innerText = "FINALIZAR COMPRA";
            }
        } catch (error) { btn.disabled = false; btn.innerText = "FINALIZAR COMPRA"; }
    }

    function mostrarExito(datos, cliente, direccion, pago, entrega) {
        document.getElementById('btn-ver-carrito').classList.remove('expanded');
        document.getElementById('res-pedido-id').innerText = datos.pedidoId;
        
        let detalleTexto = ""; let detalleWsp = "";
        carrito.forEach(p => {
            detalleTexto += `${p.cantidad}x ${p.nombre}<br>`;
            detalleWsp += `‚úÖ ${p.cantidad}x ${p.nombre}\n`;
        });

        document.getElementById('ticket-final').innerHTML = `<strong>CLIENTE:</strong> ${cliente}<br><strong>TOTAL:</strong> $${datos.total.toLocaleString('es-AR')}<br><br>${detalleTexto}`;
        
        const contenedorExtra = document.getElementById('contenedor-info-extra');
        const infoTransf = document.getElementById('info-transferencia');
        const infoRetiro = document.getElementById('info-retiro');
        contenedorExtra.style.display = 'none'; infoTransf.style.display = 'none'; infoRetiro.style.display = 'none';

        if(pago === 'transferencia') { contenedorExtra.style.display = 'block'; infoTransf.style.display = 'block'; } 
        if(entrega === 'retiro') { contenedorExtra.style.display = 'block'; infoRetiro.style.display = 'block'; }

        const msg = `*NUEVO PEDIDO #${datos.pedidoId} - HIGH BLEND* üçî\n\nüë§ *Cliente:* ${cliente}\nüìç *Entrega:* ${entrega.toUpperCase()}\nüè† *Direcci√≥n:* ${direccion}\nüí≥ *Pago:* ${pago.toUpperCase()}\n--------------------------\n${detalleWsp}--------------------------\nüí∞ *TOTAL: $${datos.total.toLocaleString('es-AR')}*`;
        
        const btnWsp = document.getElementById('link-wsp');
        btnWsp.href = `https://wa.me/5491168184740?text=${encodeURIComponent(msg)}`;
        btnWsp.onclick = () => {
            toggleModal('modal-exito', false);
            document.getElementById('nombre').value = ''; document.getElementById('direccion').value = ''; document.getElementById('tel').value = '';
        };
        
        toggleModal('modal-exito', true);
        carrito = [];
        actualizarUI();
        const btnProcesar = document.getElementById('btn-procesar');
        btnProcesar.disabled = false; btnProcesar.innerText = "FINALIZAR COMPRA";
    }

    cargar();
</script>
</body>
</html>